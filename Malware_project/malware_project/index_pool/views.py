from django.shortcuts import render
from django.http import HttpResponse
from django.core.files.storage import FileSystemStorage
from index_pool.models import *
from django.http import JsonResponse
from django.contrib.auth.decorators import login_required
from index_pool.functions import *
from django.db import IntegrityError
# Create your views here.


def index(request):
    return render(request,'index_pool/index.html',{})


def upload(request):
    if request.user.is_authenticated:
        print("este autentificat")
    else:
        print("nu este autentificat")

    context={}
    if request.method=='POST':
        uploaded_file=request.FILES['document']
        fs=FileSystemStorage()
        name=fs.save(uploaded_file.name,uploaded_file)
        context['url']=fs.url(name)
        sha = make_sha(uploaded_file.name)
        yara = apply_yara_rules(uploaded_file.name)
        print(yara)
        try:
            mw = Malware(mw_name="ceva1",mw_sha256=sha)
            #mw.save()
        except IntegrityError:
            return JsonResponse({'error':False,'message':'Malicious file is already in our database.'})
        string=get_static_info_from_header(uploaded_file.name)
        return JsonResponse({'error':False,'message':'Uploaded Successfully'})
    return render(request,'index_pool/upload.html',context)

def upload_malware(request):
    print("am intrat in upload malware")
    return render(request,'index',context);
