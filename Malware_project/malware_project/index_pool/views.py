from django.shortcuts import render
from django.http import HttpResponse
from django.core.files.storage import FileSystemStorage
from index_pool.models import *
from django.http import JsonResponse
from django.contrib.auth.decorators import login_required
from index_pool.functions import *
from django.db import IntegrityError
from datetime import datetime
# Create your views here.


def index(request):
    
    return render(request,'index_pool/index.html',{})


def upload(request):
    if request.user.is_authenticated:
        print("este autentificat")
    else:
        print("nu este autentificat")

    context={}
    if request.method=='POST':
        uploaded_file=request.FILES['document']
        fs=FileSystemStorage()
        name=fs.save(uploaded_file.name,uploaded_file)
        context['url']=fs.url(name)
        sha = make_sha(uploaded_file.name)
        string, score1, compiled_time=get_static_info_from_header(uploaded_file.name)
        yara, score2 = apply_yara_rules(uploaded_file.name)
        score=score1+score2
        now=datetime.now()
        dt_string = now.strftime("%d/%m/%Y %H:%M:%S")
        try:
            current_user=request.user
            mw = Malware(mw_name=uploaded_file.name,mw_sha256=sha,mw_creation_date=dt_string,mw_date_compiled=compiled_time,mw_headers_strings=string,user_email=current_user.email,user_username=current_user.username,mw_score=score,yara_rules=yara)
            mw.save()
        except IntegrityError:
            return JsonResponse({'error':False,'message':'Malicious file, '+sha+' is already in our database.'})

        return JsonResponse({'error':False,'message':'Uploaded Successfully'})
    return render(request,'index_pool/upload.html',context)

def upload_malware(request):
    print("am intrat in upload malware")
    return render(request,'index',context);
